# 4995 Industries Presents: Whiteboard

## What is it?

"Whiteboard" is a real-time collaborative whiteboard application developed by CS 4995 students at the University of Minnesota-Duluth.

## Setup

1. Download and set up the [NodeJS whiteboard server](https://github.umn.edu/umdcs4995/nodejs)
2. Change the values in app/src/main/res/values/strings.xml to match your server address
    - Change "hostname" to your server hostname
    - Change rtc_port to your RTC signalling port (3001 by default)
    - If your server is NOT running over HTTPS (most people):
        - Change "secure" to false
        - Change "port" to your server port (3000 by default)
    - Otherwise, if you ARE running over HTTPS:
        - Change "secure_port" to your HTTPS port
3. Build and run the Android application (we use Android Studio)

## Nodejs Development Information

The server is written in Javascript using [Nodejs](https://nodejs.org), and most of the client-server communication uses [Socket.IO](http://socket.io/). This means that most of the communication is *asynchronous*, so you need to write your code in a way that can be executed asynchronously without problems. There are good examples of this in JoinBoardFragment.java.

### Building messages

Message data needs to be packaged in a JSONObject or JSONArray in order to be sent via socketio. This is pretty easy to do:

    JSONObject jsonData = new JSONObject();
    jsonData.put("name", "testBoard");

Sometimes it helps to think about JSONObjects is as HashMap<String,Object> and JSONArrays as List<Object> (though technically speaking, this isn't totally correct).

### Sending and receiving a message

In order to send or receive a message, your class needs to have access to the global SocketService. You can access this through the Globals singleton:

    final SocketService socket = Globals.getInstance().getSocketService();

Sending a message can be done through the sendMessage method, which takes a string and either a string, JSONObject, or JSONArray. Message types are stored in a "struct" called Messages within SocketService.

    socket.sendMessage(SocketService.Messages.CREATE_WHITEBOARD, jsonData);

SendMessage will throw an error if it does not have a connection to the server, so make sure to check for that.

To receive a message, you need to set up a listener, which is usually an anonymous function that will get called when the server send s message back with the given message type (such as createWhiteboard).

For example, to set up a listener to for a createWhiteboard message,

    socket.addListener(SocketService.Messages.CREATE_WHITEBOARD, new Emitter.Listener() {
        @Override
        public void call(Object... args) {
            
            // args[0] is a string containing the server's response, which we parse into a JSONObject
            JSONObject recvd = (JSONObject) args[0];
            
            try {
                Log.i("createWhiteboard", "received message: " + recvd.getString("message"));
            } catch (JSONException e) {
                Log.e("createWhiteboard", "error parsing received message");
            }
            
            // After we have successfully processed the response, 
            // remove the listener so it doesn't get called again.
            socket.clearListener(SocketService.Messages.CREATE_WHITEBOARD);
        }
    });

### Debugging messages

You can see a live log of the public server at https://lempo.d.umn.edu:4995/log.html

Additionally, you can simulate a real client and test sending messages at https://lempo.d.umn.edu:4995/console.html

### Server message types

|       Name       |       Purpose         | Arguments | Returns |
| ---------------- | --------------------- | --------- | ------- |
| createWhiteboard | Creates a whiteboard. | name | A success or error message |
| joinWhiteboard   | Joins a whiteboard.   | name | A success or error message |
| deleteWhiteboard | Deleted a whiteboard. | name | A success or error message |
| me               | Allows user to get information about themselves | none | A JSONObject with 'whiteboard' property containing user's current whiteboard |
| chat message     | Blast a message to all users | message | The message |
| drawevent        | Sends a drawevent to users in the current whiteboard | drawevent object generated by DrawProtocol | none |


## Contributors

Put your name and email/website here! Leave a blank line between names.

[Mitchell Rysavy](http://d.umn.edu/~rysau001) ([rysau001@d.umn.edu](mailto:rysau001@d.umn.edu))

